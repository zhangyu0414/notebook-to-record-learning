# æ€è€ƒå¦‚ä½•ä¸åœ¨é€šè¿‡å›¾ç‰‡æœåŠ¡å»ç”Ÿæˆå›¾ç‰‡

## å‰è¨€

è¿™æ®µæ—¶é—´çš„å·¥ä½œä¸­ï¼Œå› ä¸ºä¸šåŠ¡ä¸­é¢‘ç¹çš„ä½¿ç”¨å›¾ç‰‡æ¨¡æ¿çš„jsonæ•°æ®å»æ¸²æŸ“å›¾ç‰‡ï¼Œå¯¼è‡´æ¸²æŸ“æ—¶é•¿æ¯”è¾ƒä¹…ï¼Œåœ¨éƒ¨åˆ†ä¸šåŠ¡æ“ä½œæ—¶å€™éœ€è¦è°ƒç”¨å…¬å¸çš„å›¾ç‰‡æœåŠ¡ï¼ŒğŸ˜”ğŸ˜”ï¼Œâ•®(â•¯â–½â•°)â•­å“ï¼Œåæ¥æƒ³å°è¯•ç”¨html2canvasæ¥è½¬ä¸ºcanvaså†å»å¯¼å‡ºå›¾ç‰‡ï¼Œä½†æ˜¯å‘ç°html2canvasè½¬åŒ–æˆ‘ä»¬ç‰¹æ•ˆå­—ä½“çš„æ—¶å€™å‡ºç°ä¸€äº›ä¸ç†æƒ³æ•ˆæœï¼Œä½†æ˜¯è¿™ä¸ªæ¡†æ¶è¿‘æœŸæœ‰åšæ›´æ–°ï¼Œå¹¶ä¸”å¯¹äºæ¯ä¸ªcssæ ·å¼éƒ½æœ‰åšæµ‹è¯•ç”¨ä¾‹ï¼Œä»–ä»¬è‡ªå·±å®ç°äº†ä¸€å¥—cssè§£æï¼Œç„¶åå°±å†GitHubä¸Šæ‰¾åˆ° domtoimageè¿™ä¸ªjsæ’ä»¶æ˜¯é€šè¿‡æµè§ˆå™¨å†…ç½®çš„apiåšcssè§£æï¼Œæ•ˆæœä¼šæ¯”html2canvaså¥½ï¼Œä½†æ˜¯æ‹“å±•æ€§ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œæ‰€ä»¥æƒ³åšä¸€ä¸ªè¿™ä¸¤ä¸ªæ’ä»¶çš„æ·±åº¦åˆ†æã€‚


## domtoimage å’Œhtml2canvas å¯¹æ¯”

#### HTML to imageæœ‰ä¸¤ç§æ–¹æ¡ˆæ¯”è¾ƒæµè¡Œï¼Œä¸€ä¸ªæ˜¯html2canvasï¼Œä¸€ä¸ªæ˜¯dom-to-imageã€‚å®ƒä»¬çš„è®¾è®¡åˆè¡·å…¶å®éƒ½æ˜¯å°†å·²æœ‰DOMç»“æ„è½¬æˆå›¾ç‰‡ç±»å‹ã€‚å¯¹æ¯”æ¥çœ‹

* æµè¡Œåº¦ä¸Šï¼Œhtml2canvasæµè¡Œåº¦æ›´é«˜ï¼Œèµ„æ–™æ›´å¥½æ‰¾ï¼Œä½†æ›´æ–°ç¼“æ…¢
* æ ¼å¼æ”¯æŒä¸Šï¼Œdom-to-imageå¯ä»¥å°†å›¾è½¬æˆSVGç­‰æ›´å¤šæ ¼å¼ï¼Œhtml2canvasåªèƒ½è¾“å‡ºcanvasï¼Œéœ€è¦ç”¨æˆ·è‡ªè¡Œå¤„ç†
* æ¸…æ™°åº¦ä¸Šï¼Œdom-to-imageå¯ä»¥å¯¼å‡ºSVGï¼Œhtml2canvasåˆ™éœ€è¦hackçš„æ–¹å¼ï¼ˆè®¾ç½®æ›´å¤§çš„canvasç»˜åˆ¶å†ç­‰æ¯”ç¼©æ”¾ï¼‰
* å®ç°åŸç†ä¸Šï¼Œéƒ½æ˜¯é€šè¿‡éå†DOMæ ‘ï¼Œè¯»å–æ ¼å¼åŒ–æ•°æ®ï¼Œdom-to-imageé€šè¿‡æµè§ˆå™¨è§£æCSSè¯­æ³•ï¼Œå› æ­¤æ”¯æŒåº¦æ›´é«˜ï¼›html2canvasåˆ™è‡ªå·±å®ç°äº†CSSè§£æ
* é€Ÿåº¦ä¸Šï¼Œç›¸åŒæ¨¡æ¿dom-to-imageæ˜¯ç¨å¾®å¿«ä¸€ç‚¹åŒ…æ‹¬å¯¼å‡ºimgçš„æ—¶é—´å¤§çº¦ä¸º1000msä¸Šä¸‹ï¼Œè€Œhtml2canvasç”Ÿæˆcanvaså°±ä¼šåœ¨1100mså·¦å³ã€‚

#### æ¸²æŸ“å›¾ç‰‡çš„HTMLæ¨¡æ¿åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸åº”è¯¥å±•ç¤ºç»™ç”¨æˆ·ã€‚å³ç”Ÿæˆè¿‡ç¨‹çŸ­æš‚åœç•™çš„DOMéœ€è¦ç”¨æˆ·ä¸å¯è§ã€‚ä¸å¯è§çš„æ–¹å¼å¤§è‡´æœ‰ä¸‹é¢å‡ ç§ï¼š

* display: noneï¼Œè¿™ç§æƒ…å†µï¼Œä¸¤ä¸ªæ–¹æ¡ˆåº¦éƒ½è¾“å‡ºç©ºç™½å›¾ç‰‡
* visibility: hiddenï¼Œåœ¨è¾“å‡ºå›¾ç‰‡æ—¶ï¼ŒDOMç»“æ„ä¼šçŸ­æš‚é—ªç°ï¼Œä¸¤ç§æ–¹æ¡ˆéƒ½è¾“å‡ºç©ºç™½å›¾ç‰‡
* å°†DOMç§»å‡ºè§†å£ï¼Œhtml2canvaså¯ä»¥æ­£ç¡®è¾“å‡ºå›¾ç‰‡ï¼Œdom-to-imageä¸è¡Œ


## å·²çŸ¥ç¼ºé™·

* å¯¹éƒ¨åˆ†CSSå±æ€§æ”¯æŒåº¦æœ‰é™ï¼Œå¦‚box-shadowï¼Œ-webkit-line-clampï¼Œbackground-positionç­‰ã€‚
* ä½¿ç”¨æ—¶éœ€è¦é¢å¤–çš„å¸è½½æ“ä½œã€‚
* domtoimageæ— æ³•å…¼å®¹å›¾å½¢é®ç½©mask-box-imageï¼Œå’Œsvg çš„é˜´å½±drop-shadowã€‚

## domtoimage å’Œ html2canvas å·¥ä½œåŸç†

### domtoimage
ä½¿ç”¨`svg`çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå…è®¸åœ¨`<foreignobject>`æ ‡ç­¾ä¸­åŒ…å«ä»»æ„çš„`html`å†…å®¹ã€‚ï¼ˆä¸»è¦æ˜¯ XMLSerializer | MDNè¿™ä¸ª`api`å°†`dom`è½¬ä¸º`svg`ï¼‰ æ‰€ä»¥ï¼Œä¸ºäº†æ¸²æŸ“é‚£ä¸ª`dom`èŠ‚ç‚¹ï¼Œä½ éœ€è¦é‡‡å–ä»¥ä¸‹æ­¥éª¤ï¼š
1.  é€’å½’ `clone` åŸå§‹çš„ `dom` èŠ‚ç‚¹
2.  è·å– èŠ‚ç‚¹ä»¥åŠå­èŠ‚ç‚¹ ä¸Šçš„ `computed style`ï¼Œå¹¶å°†è¿™äº›æ ·å¼æ·»åŠ è¿›æ–°å»ºçš„styleæ ‡ç­¾ä¸­ï¼ˆä¸è¦å¿˜è®°äº†clone ä¼ªå…ƒç´ çš„æ ·å¼ï¼‰
3.  åµŒå…¥ç½‘é¡µå­—ä½“

*   æ‰¾åˆ°æ‰€æœ‰çš„`@font-face`
*   è§£æURLèµ„æºï¼Œå¹¶ä¸‹è½½å¯¹åº”çš„èµ„æº
*   base64ç¼–ç å’Œå†…è”èµ„æº ä½œä¸º `data:` URLSå¼•ç”¨
*   æŠŠä¸Šé¢å¤„ç†å®Œçš„`css rules`å…¨éƒ¨éƒ½æ”¾è¿›`<style>`ä¸­ï¼Œå¹¶æŠŠæ ‡ç­¾åŠ å…¥åˆ°cloneçš„èŠ‚ç‚¹ä¸­å»
4.  å†…åµŒå›¾ç‰‡(éƒ½è½¬æˆdataUrl)
*   å†…è”å›¾ç‰‡src çš„url è¿› `<img>`å…ƒç´ 
*   èƒŒæ™¯å›¾ç‰‡ ä½¿ç”¨ background css å±æ€§ï¼Œç±»ä¼¼fontsçš„ä½¿ç”¨æ–¹å¼
5.  åºåˆ—åŒ– clone çš„ dom èŠ‚ç‚¹ ä¸º `svg`
6.  å°†xmlåŒ…è£…åˆ°`<foreignobject>`æ ‡ç­¾ä¸­ï¼Œæ”¾å…¥`svg`ä¸­ï¼Œç„¶åå°†å…¶ä½œä¸º`data: url`
7.  å°†pngå†…å®¹æˆ–åŸå§‹æ•°æ®ä½œä¸º`uint8array`è·å–ï¼Œä½¿ç”¨svgä½œä¸ºæºåˆ›å»ºä¸€ä¸ª`img`æ ‡ç­¾ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°æ–°åˆ›å»ºçš„`canvas`ä¸Šï¼Œç„¶åæŠŠ`canvas`è½¬ä¸º`base64`
8.  å®Œæˆ

### html2canvas

1.  éå†é¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œæå–DOMèŠ‚ç‚¹ï¼Œå¡«å……åˆ°ä¸€ä¸ªrederListï¼Œå¹¶é™„åŠ æ˜¯å¦ä¸ºé¡¶å±‚å…ƒç´ /åŒ…å«å†…å®¹çš„å®¹å™¨ç­‰ä¿¡æ¯
2.  é€šè¿‡æå–çš„csså±æ€§å’Œå…ƒç´ çš„å±‚çº§ä¿¡æ¯å°†rederListæ’åºï¼Œè®¡ç®—å‡ºä¸€ä¸ªcanvasçš„renderQueue
3.  éå†renderQueueï¼Œå°†cssæ ·å¼è½¬ä¸ºsetFillStyleå¯è¯†åˆ«çš„å‚æ•°ï¼Œä¾æ®nodeTypeè°ƒç”¨ç›¸å¯¹åº”canvasæ–¹æ³•ï¼Œå°†èŠ‚ç‚¹å¯¹åº”åˆ° canvas ä¸Šã€‚

è¡¥å……ï¼šhtml2canvas ä¸Š/testsæ–‡ä»¶ä¸‹é¢æœ‰å„ä¸ªæ ·å¼çš„å…¼å®¹æƒ…å†µï¼Œå¹¶ä¸”æœ‰å„ç§æ ·å¼çš„render timeï¼Œå¼€å‘åŒå­¦å¯ä»¥ç›´æ¥ä¸Šé¢è¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥html2canvasæ›´é€‚åˆæ‹¿æ¥åšå°è¯•

## åˆ†æ domtoimage å†…éƒ¨ toPng æ–¹æ³•çš„åŸç†

> å°½é‡æŒ‘æœ€æ ¸å¿ƒçš„è®²ï¼Œå¸Œæœ›ä¸ä¼šæ˜¾å¾—å¾ˆç¹çï¼Œäº†è§£æ ¸å¿ƒæ€æƒ³å°±å¥½

![](https://user-gold-cdn.xitu.io/2018/3/6/161f8d2e90d57677?w=915&h=404&f=png&s=73283)

ä¸‹é¢ä»‹ç»å‡ ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

*   toPng ï¼ˆåŒ…è£…äº†drawå‡½æ•°ï¼Œæ²¡å•¥æ„ä¹‰ï¼‰
*   Draw ï¼ˆdom => canvasï¼‰
*   toSvg ï¼ˆdom => svgï¼‰
*   cloneNode ï¼ˆclone domæ ‘å’Œcssæ ·å¼ï¼‰
*   makeSvgDataUri ï¼ˆdom => svg => data:uriï¼‰

è°ƒç”¨é¡ºåºä¸º

    toPng è°ƒç”¨ Draw
    Draw è°ƒç”¨ toSvg
    toSvg è°ƒç”¨ cloneNode
    

**toPngæ–¹æ³•ï¼š**

```
// é‡Œé¢å…¶å®å°±æ˜¯è°ƒç”¨äº† draw æ–¹æ³•ï¼Œpromiseè¿”å›çš„æ˜¯ä¸€ä¸ªcanvaså¯¹è±¡
function toPng(node, options) {
    return draw(node, options || {})
        .then(function (canvas) {
            return canvas.toDataURL();
        });
}
```

    

**Drawæ–¹æ³•**
```
function draw(domNode, options) {
    // å°† dom èŠ‚ç‚¹è½¬ä¸º svgï¼ˆdata: urlå½¢å¼çš„svgï¼‰
    return toSvg(domNode, options)    
        // util.makeImage å°† canvas è½¬ä¸º new Image(uri)
        .then(util.makeImage)
        .then(util.delay(100))
        .then(function (image) {
            var canvas = newCanvas(domNode);
            canvas.getContext('2d').drawImage(image, 0, 0);
            return canvas;
        });

    // åˆ›å»ºä¸€ä¸ªç©ºçš„ canvas èŠ‚ç‚¹
    function newCanvas(domNode) {
        var canvas = document.createElement('canvas');
        canvas.width = options.width || util.width(domNode);
        canvas.height = options.height || util.height(domNode);
		  ......
        return canvas;
    }
}

```
    

**toSvgæ–¹æ³•**

```
  function toSvg (node, options) {
    options = options || {}
    // è®¾ç½®ä¸€äº›é»˜è®¤å€¼ï¼Œå¦‚æœoptionæ˜¯ç©ºçš„è¯
    copyOptions(options)

    return (
      Promise.resolve(node)
        .then(function (node) {
          // clone dom æ ‘
          return cloneNode(node, options.filter, true)
        })
        // æŠŠå­—ä½“ç›¸å…³çš„csstext å…¨éƒ¨éƒ½æ–°å»ºä¸€ä¸ª stylesheet æ·»åŠ è¿›å»
        .then(embedFonts)
        // å¤„ç†imgå’Œbackground url('')é‡Œé¢çš„èµ„æºï¼Œè½¬æˆdataUrl
        .then(inlineImages)
        // æŠŠoption é‡Œé¢çš„ä¸€äº› style æ”¾è¿›stylesheeté‡Œé¢
        .then(applyOptions)
        .then(function (clone) {
          // node èŠ‚ç‚¹åºåˆ—åŒ–æˆ svg
          return makeSvgDataUri(
            clone,
            // util.width å°±æ˜¯ getComputedStyle è·å–èŠ‚ç‚¹çš„å®½
            options.width || util.width(node),
            options.height || util.height(node)
          )
        })
    )
	  // è®¾ç½®ä¸€äº›é»˜è®¤å€¼
    function applyOptions (clone) {
		......
      return clone
    }
  }

```
    

**cloneNode æ–¹æ³•**
```
  function cloneNode (node, filter, root) {
    if (!root && filter && !filter(node)) return Promise.resolve()

    return (
      Promise.resolve(node)
        .then(makeNodeCopy)
        .then(function (clone) {
          return cloneChildren(node, clone, filter)
        })
        .then(function (clone) {
          return processClone(node, clone)
        })
    )
    // makeNodeCopy
    // å¦‚æœä¸æ˜¯canvas èŠ‚ç‚¹çš„è¯ï¼Œå°±clone
    // æ˜¯çš„è¯ï¼Œå°±è¿”å› canvasè½¬imageçš„ img å¯¹è±¡
    function makeNodeCopy (node) {
      if (node instanceof HTMLCanvasElement) { return util.makeImage(node.toDataURL()) }
      return node.cloneNode(false)
    }
    // clone å­èŠ‚ç‚¹ ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰
    function cloneChildren (original, clone, filter) {
      var children = original.childNodes
      if (children.length === 0) return Promise.resolve(clone)

      return cloneChildrenInOrder(clone, util.asArray(children), filter).then(
        function () {
          return clone
        }
      )
      // é€’å½’ clone èŠ‚ç‚¹
      function cloneChildrenInOrder (parent, children, filter) {
        var done = Promise.resolve()
        children.forEach(function (child) {
          done = done
            .then(function () {
              return cloneNode(child, filter)
            })
            .then(function (childClone) {
              if (childClone) parent.appendChild(childClone)
            })
        })
        return done
      }
    }
    
    // å¤„ç†æ·»åŠ domçš„cssï¼Œå¤„ç†svg
    function processClone (original, clone) {
      if (!(clone instanceof Element)) return clone

      return Promise.resolve()
        // è¯»å–èŠ‚ç‚¹çš„getComputedStyleï¼Œæ·»åŠ è¿›cssä¸­
        .then(cloneStyle)
        // è·å–ä¼ªç±»çš„cssï¼Œæ·»åŠ è¿›css
        .then(clonePseudoElements)
        // è¯»å– input textarea çš„value
        .then(copyUserInput)
        // è®¾ç½®svg çš„ xmlns
        // å‘½åç©ºé—´å£°æ˜ç”±xmlnså±æ€§æä¾›ã€‚æ­¤å±æ€§è¡¨ç¤º<svg>æ ‡è®°åŠå…¶å­æ ‡è®°å±äºåç§°ç©ºé—´ä¸ºâ€œhttp://www.w3.org/2000/svgâ€çš„XMLæ–¹è¨€
        .then(fixSvg)
        .then(function () {
          return clone
        })


```
    

> ä¸‹é¢æ˜¯è¿™ç¯‡çš„é‡ç‚¹ æŠŠ `html` èŠ‚ç‚¹åºåˆ—åŒ–æˆ `svg`

```
  // node èŠ‚ç‚¹åºåˆ—åŒ–æˆ svg
  function makeSvgDataUri (node, width, height) {
    return Promise.resolve(node)
      .then(function (node) {
        node.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml')

        // XMLSerializer å¯¹è±¡ä½¿ä½ èƒ½å¤ŸæŠŠä¸€ä¸ª XML æ–‡æ¡£æˆ– Node å¯¹è±¡è½¬åŒ–æˆ–â€œåºåˆ—åŒ–â€ä¸ºæœªè§£æçš„ XML æ ‡è®°çš„ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚
        // è¦ä½¿ç”¨ä¸€ä¸ª XMLSerializerï¼Œä½¿ç”¨ä¸å¸¦å‚æ•°çš„æ„é€ å‡½æ•°å®ä¾‹åŒ–å®ƒï¼Œç„¶åè°ƒç”¨å…¶ serializeToString() æ–¹æ³•ï¼š
        return new XMLSerializer().serializeToString(node)
      })
      // escapeXhtmlä»£ç æ˜¯string.replace(/#/g, '%23').replace(/\n/g, '%0A')
      .then(util.escapeXhtml)
      .then(function (xhtml) {
        return (
          '<foreignObject x="0" y="0" width="100%" height="100%">' +
          xhtml +
          '</foreignObject>'
        )
      })
      // å˜æˆsvg
      .then(function (foreignObject) {
        return (
          '<svg xmlns="http://www.w3.org/2000/svg" width="' +
          width +
          '" height="' +
          height +
          '">' +
          foreignObject +
          '</svg>'
        )
      })
      // å˜æˆ data: url
      .then(function (svg) {
        return 'data:image/svg+xml;charset=utf-8,' + svg
      })
  }


```

å‚è€ƒé“¾æ¥
----

*   [CSSStyleDeclaration.setProperty() - Web API æ¥å£ | MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/CSSStyleDeclaration/setProperty)
    
*   [dom-to-image](https://github.com/tsayen/dom-to-image)
    
*   [XML DOM - XMLSerializer å¯¹è±¡](http://www.w3school.com.cn/xmldom/dom_xmlserializer.asp)

## ç®€æ´çš„domtoimage

domtoimage ä¸»è¦ä»£ç æ‰700å¤šè¡Œï¼Œæ–¹æ³•å’Œå±æ€§éƒ½æ¯”è¾ƒå°‘ï¼Œä¸‹è½½ä¹‹åçœ‹ä¸€ä¸‹å°±çŸ¥é“æ€ä¹ˆç”¨ï¼Œæœ‰äº›ä»€ä¹ˆåŠŸèƒ½ã€‚è™½ç„¶html2canvas ä»£ç 3000å¤šè¡Œï¼Œè°ƒç”¨å…¶å®ä¹Ÿæ˜¯ä¸éš¾ï¼Œä½†ç›¸å¯¹æ¥è¯´ä»£ç ç¡®å®æ¯”domtoimageå¤šäº†å¾ˆå¤šã€‚

### domtoimage è¿ç”¨åœºæ™¯
#### ä¸»è¦çš„æ–¹æ³•æœ‰ï¼š

domtoimage.toPng(...);å°†èŠ‚ç‚¹è½¬åŒ–ä¸ºpngæ ¼å¼çš„å›¾ç‰‡

```
var node = document.getElementById('my-node');

domtoimage.toPng(node)
    .then(function (dataUrl) {
        var img = new Image();
        img.src = dataUrl;
        document.body.appendChild(img);
    })
    .catch(function (error) {
        console.error('oops, something went wrong!', error);
    });
```

domtoimage.toJpeg(...);å°†èŠ‚ç‚¹è½¬åŒ–ä¸ºjpgæ ¼å¼çš„å›¾ç‰‡

```
domtoimage.toJpeg(document.getElementById('my-node'), { quality: 0.95 })
    .then(function (dataUrl) {
        var link = document.createElement('a');
        link.download = 'my-image-name.jpeg';
        link.href = dataUrl;
        link.click();
    });

```

domtoimage.toSvg(...);å°†èŠ‚ç‚¹è½¬åŒ–ä¸ºsvgæ ¼å¼çš„å›¾ç‰‡ï¼Œç”Ÿæˆçš„å›¾ç‰‡çš„æ ¼å¼éƒ½æ˜¯base64æ ¼å¼ã€‚

```
function filter (node) {
    return (node.tagName !== 'i');
}

domtoimage.toSvg(document.getElementById('my-node'), {filter: filter})
    .then(function (dataUrl) {
        /* do something */
    });

```

domtoimage.toBlob(...);å°†èŠ‚ç‚¹è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ ¼å¼ï¼Œè¿™ä¸ªå¯ä»¥ç›´æ¥å°†å›¾ç‰‡ä¸‹è½½ï¼Œæ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿

```
domtoimage.toBlob(document.getElementById('my-node'))
    .then(function (blob) {
        window.saveAs(blob, 'my-node.png');
    });

```

domtoimage.toPixelData(...);è·å–åŸå§‹åƒç´ å€¼ï¼Œä»¥Uint8Array æ•°ç»„çš„å½¢å¼è¿”å›ï¼Œæ¯4ä¸ªæ•°ç»„å…ƒç´ è¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹ï¼Œå³rgbaå€¼ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æŒºå®ç”¨çš„ï¼Œå¯ä»¥ç”¨äºWebGLä¸­ç¼–å†™ç€è‰²å™¨é¢œè‰²ã€‚

```
var node = document.getElementById('my-node');

domtoimage.toPixelData(node)
    .then(function (pixels) {
        for (var y = 0; y < node.scrollHeight; ++y) {
          for (var x = 0; x < node.scrollWidth; ++x) {
            pixelAtXYOffset = (4 * y * node.scrollHeight) + (4 * x);
            /* pixelAtXY is a Uint8Array[4] containing RGBA values of the pixel at (x, y) in the range 0..255 */
            pixelAtXY = pixels.slice(pixelAtXYOffset, pixelAtXYOffset + 4);
          }
        }
    });

```

### domtoimage ä¸»è¦çš„å±æ€§æœ‰ï¼š

filter ï¼š è¿‡æ»¤å™¨èŠ‚ç‚¹ä¸­é»˜å†™ä¸éœ€è¦çš„èŠ‚ç‚¹ï¼›

bgcolor ï¼š å›¾ç‰‡èƒŒæ™¯é¢œè‰²ï¼›

height, width ï¼š å›¾ç‰‡å®½é«˜ï¼›

style ï¼šä¼ å…¥èŠ‚ç‚¹çš„æ ·å¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„æ ·å¼ï¼›

quality ï¼š å›¾ç‰‡çš„è´¨é‡ï¼Œä¹Ÿå°±æ˜¯æ¸…æ™°åº¦ï¼›

cacheBust ï¼š å°†æ—¶é—´æˆ³åŠ å…¥åˆ°å›¾ç‰‡çš„urlä¸­ï¼Œç›¸å½“äºæ·»åŠ æ–°çš„å›¾ç‰‡ï¼›

imagePlaceholder ï¼š å›¾ç‰‡ç”Ÿæˆå¤±è´¥æ—¶ï¼Œåœ¨å›¾ç‰‡ä¸Šé¢çš„æç¤ºï¼Œç›¸å½“äºimgæ ‡ç­¾çš„altï¼›

[ä¸Šé¢çš„è¿™äº›æ‘˜è‡ª GitHub](https://github.com/tsayen/dom-to-image)

# å¯¹æ­¤æƒ³è¡¥å……ä¸‹html2canvaså•ä¾‹æµ‹è¯•ç»“æœ
1. position + index è¿™å—è½¬åŒ–æ­£å¸¸ã€è€—æ—¶300ms
2. boderä¸Šæ”¯æŒä¸å¤ªå¥½
3. transformæ”¯æŒæ•ˆæœçš„ä¸å¤ªå¥½ã€å¯ä»¥å°è¯•ç”¨canvas å»æ¨¡æ‹Ÿ scale å’Œ translateã€ç„¶åè¿›è¡Œè£å‰ª
4. å¯¹äºtext multiple underlineçº¿ä¼šå˜ç»†ã€shadowè‹¥colorè®¾ç½®ä¸ºé€æ˜ï¼Œæ— è®ºè®¾ç½®å…¶ä»–æ ·å¼è½¬åŒ–åéƒ½ä¼šæ˜¯é€æ˜ï¼Œæˆ–è€…åœ¨å­—ä½“ä¸ŠåŠ ä¸Šbackground-image å’Œ -webkit-text-fill-coloræ¥åšæ–‡å­—ç‰¹æ•ˆ ä¸ -webkit-text-strokeï¼Œè¿™å—æœªåšcssè§£æ
5. canvas svg img backgroundè¿™å‡ ä¸ªå…¼å®¹éƒ½ä¸é”™
6. overflow-transform æ— æ³•æ”¯æŒ
7. clip è¿™ä¸ªæ”¯æŒæ•ˆæœè¿˜è¡Œ
8. text-shadowå¯ä»¥æ”¯æŒï¼Œä½†æ˜¯æ–‡å­—éƒ½ä¼šå‘ä¸‹ç§»åŠ¨ï¼Œå…¶å®è¿™å—å¯¹äºæ–‡å­—è½¬åŒ–åè·Ÿç°æœ‰ä½ç½®æœ‰æ‰€åå·®
9. å…¶å®ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œhtml2canvasæºç é‡Œå°±å¾ˆæ¸…æ¥šäº†
![](http://thyrsi.com/t6/648/1546424182x2890211750.png)
ä»–å°±åªæœ‰æ”¯æŒäº†è¿™äº›å±æ€§ï¼Œå¦‚æœéœ€è¦æ”¯æŒæ›´å¤šcsså±æ€§ï¼Œéœ€è¦å¯¹æ­¤åšå¹²é¢„äº†ï¼

# æ€»ç»“

* domtoimage æ€§èƒ½è¿˜æ˜¯å¾ˆä¸é”™ï¼Œä¼˜äºhtml2canvasï¼Œä»£ç å°‘ï¼Œæ€§èƒ½é«˜ï¼Œåº”ç”¨ç®€å•ã€‚
* æ„Ÿè§‰è¿™ä¸¤ä¸ªæ’ä»¶éƒ½å¾ˆç›¸ä¼¼ï¼Œä¸»è¦ä½†æ˜¯html2canvasæ˜¯è‡ªå·±å®ç°äº†CSSè§£æï¼Œæ‰€ä»¥åœ¨å¯å¹²é¢„æƒ…å†µä¸‹ï¼Œä¼˜äºdomtoimageï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ƒcssè§£æçš„ç¨‹åº¦ä¸Šæ·»åŠ é€‚åˆä¸šåŠ¡çš„æ›´ä¼˜çš„cssè§£ææ–¹å¼ã€‚
